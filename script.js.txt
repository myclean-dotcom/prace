// script.js - –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
// =============== –û–°–ù–û–í–ù–û–ô –ö–û–î –°–ò–°–¢–ï–ú–´ ===============

// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
let currentStep = 1;
let currentOrder = null;
let selectedCity = null;
let calculatedPrice = 0;
let orderId = null;

// DOM –≠–õ–ï–ú–ï–ù–¢–´
let elements = {};

// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
document.addEventListener('DOMContentLoaded', function() {
    initializeElements();
    initializeSystem();
    setupEventListeners();
    updateDateTime();
    setInterval(updateDateTime, 60000); // –û–±–Ω–æ–≤–ª—è—Ç—å –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
});

// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø DOM –≠–õ–ï–ú–ï–ù–¢–û–í
function initializeElements() {
    // –ü–∞–Ω–µ–ª–∏
    elements.panels = {
        calculator: document.getElementById('calculatorPanel'),
        data: document.getElementById('dataPanel'),
        publish: document.getElementById('publishPanel')
    };
    
    // –®–∞–≥–∏
    elements.steps = document.querySelectorAll('.step');
    
    // –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    elements.nextToData = document.getElementById('nextToData');
    elements.nextToPublish = document.getElementById('nextToPublish');
    elements.prevToCalc = document.getElementById('prevToCalc');
    elements.prevToData = document.getElementById('prevToData');
    
    // –§–æ—Ä–º–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    elements.citiesGrid = document.getElementById('citiesGrid');
    elements.serviceCards = document.querySelectorAll('.service-card');
    elements.areaSize = document.getElementById('areaSize');
    elements.areaSlider = document.getElementById('areaSlider');
    elements.roomType = document.getElementById('roomType');
    elements.difficultySlider = document.getElementById('difficultySlider');
    elements.difficultyValue = document.getElementById('difficultyValue');
    elements.difficultyPercent = document.getElementById('difficultyPercent');
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
    elements.windowsCount = document.getElementById('windowsCount');
    elements.cabinetsCount = document.getElementById('cabinetsCount');
    elements.fridgeCount = document.getElementById('fridgeCount');
    elements.ovenCount = document.getElementById('ovenCount');
    elements.hoodCount = document.getElementById('hoodCount');
    elements.appliancesCount = document.getElementById('appliancesCount');
    elements.farTrip = document.getElementById('farTrip');
    elements.hasPets = document.getElementById('hasPets');
    
    // –°—á–µ—Ç—á–∏–∫–∏
    elements.counterButtons = document.querySelectorAll('.btn-counter');
    
    // –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞
    elements.basePrice = document.getElementById('basePrice');
    elements.extraPrice = document.getElementById('extraPrice');
    elements.difficultyAdd = document.getElementById('difficultyAdd');
    elements.totalPrice = document.getElementById('totalPrice');
    elements.refreshCalc = document.getElementById('refreshCalc');
    
    // –§–æ—Ä–º–∞ –¥–∞–Ω–Ω—ã—Ö
    elements.customerName = document.getElementById('customerName');
    elements.customerPhone = document.getElementById('customerPhone');
    elements.customerStreet = document.getElementById('customerStreet');
    elements.customerFlat = document.getElementById('customerFlat');
    elements.orderDate = document.getElementById('orderDate');
    elements.orderTime = document.getElementById('orderTime');
    elements.orderTotal = document.getElementById('orderTotal');
    elements.masterPay = document.getElementById('masterPay');
    elements.paymentButtons = document.querySelectorAll('.btn-payment-option');
    elements.quickDateButtons = document.querySelectorAll('.btn-quick-date');
    elements.worksDescription = document.getElementById('worksDescription');
    elements.charCount = document.getElementById('charCount');
    elements.equipmentTags = document.getElementById('equipmentTags');
    elements.chemistryTags = document.getElementById('chemistryTags');
    
    // –ü—É–±–ª–∏–∫–∞—Ü–∏—è
    elements.previewOrderId = document.getElementById('previewOrderId');
    elements.previewCity = document.getElementById('previewCity');
    elements.previewType = document.getElementById('previewType');
    elements.previewArea = document.getElementById('previewArea');
    elements.previewPrice = document.getElementById('previewPrice');
    elements.previewDate = document.getElementById('previewDate');
    elements.previewChannel = document.getElementById('previewChannel');
    
    elements.statusSection = document.getElementById('statusSection');
    elements.statusMessage = document.getElementById('statusMessage');
    elements.resultCard = document.getElementById('resultCard');
    elements.errorCard = document.getElementById('errorCard');
    elements.actionButtons = document.getElementById('actionButtons');
    
    elements.btnPublish = document.getElementById('btnPublish');
    elements.btnCopyOrder = document.getElementById('btnCopyOrder');
    elements.btnTelegram = document.getElementById('btnTelegram');
    elements.btnRetry = document.getElementById('btnRetry');
    
    elements.resultOrderId = document.getElementById('resultOrderId');
    elements.resultCity = document.getElementById('resultCity');
    elements.resultChannelLink = document.getElementById('resultChannelLink');
    elements.errorMessage = document.getElementById('errorMessage');
    
    // –í—Ä–µ–º—è –∏ –¥–∞—Ç–∞
    elements.currentTime = document.getElementById('currentTime');
    elements.currentDate = document.getElementById('currentDate');
    
    // –ú–µ–Ω–µ–¥–∂–µ—Ä
    elements.managerName = document.getElementById('managerName');
}

// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´
function initializeSystem() {
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –≥–æ—Ä–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫)
    renderCities();
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ —Ö–∏–º–∏—é
    renderEquipmentTags();
    renderChemistryTags();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∑–∞–≤—Ç—Ä–∞)
    setDefaultDateTime();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–∞—Å–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    setupPhoneMask();
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
    calculatePrice();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    updatePreview();
    
    // –í—ã–±–∏—Ä–∞–µ–º –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    selectDefaultCity();
}

// –í–´–ë–†–ê–¢–¨ –ù–û–í–û–°–ò–ë–ò–†–°–ö –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
function selectDefaultCity() {
    const novosibirsk = CONFIG.CITIES.find(city => city.name === '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫');
    if (novosibirsk) {
        selectCity(novosibirsk);
    }
}

// –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ì–û–†–û–î–û–í
function renderCities() {
    elements.citiesGrid.innerHTML = '';
    
    CONFIG.CITIES.forEach(city => {
        const cityCard = document.createElement('div');
        cityCard.className = 'city-card';
        cityCard.innerHTML = `
            <div class="city-icon" style="background: ${city.color}">
                <i class="fas ${city.icon}"></i>
            </div>
            <div class="city-name">${city.name}</div>
            <div class="city-channel">${city.channel}</div>
        `;
        
        cityCard.addEventListener('click', () => {
            selectCity(city);
            updatePreview();
        });
        
        elements.citiesGrid.appendChild(cityCard);
    });
}

// –í–´–ë–û–† –ì–û–†–û–î–ê
function selectCity(city) {
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤
    document.querySelectorAll('.city-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // –ù–∞—Ö–æ–¥–∏–º –∏ –≤—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥
    const cityCards = document.querySelectorAll('.city-card');
    cityCards.forEach(card => {
        if (card.querySelector('.city-name').textContent === city.name) {
            card.classList.add('selected');
        }
    });
    
    selectedCity = city;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showNotification(`–í—ã–±—Ä–∞–Ω –≥–æ—Ä–æ–¥: ${city.name}`, 'info');
}

// –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–ï–ì–û–í –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø
function renderEquipmentTags() {
    elements.equipmentTags.innerHTML = '';
    
    CONFIG.EQUIPMENT.forEach(item => {
        const tag = createTag(item, 'equipment');
        elements.equipmentTags.appendChild(tag);
    });
}

// –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–ï–ì–û–í –•–ò–ú–ò–ò
function renderChemistryTags() {
    elements.chemistryTags.innerHTML = '';
    
    CONFIG.CHEMISTRY.forEach(item => {
        const tag = createTag(item, 'chemistry');
        elements.chemistryTags.appendChild(tag);
    });
}

// –°–û–ó–î–ê–ù–ò–ï –¢–ï–ì–ê
function createTag(text, type) {
    const tag = document.createElement('div');
    tag.className = 'equipment-tag';
    tag.innerHTML = `
        <i class="fas fa-${type === 'equipment' ? 'toolbox' : 'flask'}"></i>
        <span>${text}</span>
    `;
    
    tag.addEventListener('click', function() {
        this.classList.toggle('selected');
    });
    
    return tag;
}

// –í–´–ë–û–† –ö–ê–†–¢–û–ß–ö–ò –£–°–õ–£–ì–ò
function selectServiceCard(card) {
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
    elements.serviceCards.forEach(c => c.classList.remove('selected'));
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
    card.classList.add('selected');
    
    calculatePrice();
    updatePreview();
}

// –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–õ–û–ñ–ù–û–°–¢–ò
function updateDifficultyDisplay() {
    const level = parseInt(elements.difficultySlider.value);
    const multiplier = CONFIG.PRICES.difficulty[level];
    const percent = Math.round((multiplier - 1) * 100);
    
    elements.difficultyValue.textContent = level;
    elements.difficultyPercent.textContent = `+${percent}%`;
    
    // –í—ã–¥–µ–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ç–æ—á–∫—É –Ω–∞ —à–∫–∞–ª–µ
    document.querySelectorAll('.scale-point').forEach(point => {
        point.classList.toggle('active', 
            parseInt(point.getAttribute('data-level')) === level
        );
    });
}

// –†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò
function calculatePrice() {
    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø —É–±–æ—Ä–∫–∏
    const selectedCard = document.querySelector('.service-card.selected');
    if (!selectedCard) return;
    
    const cleaningType = selectedCard.getAttribute('data-type');
    const basePricePerM2 = parseInt(selectedCard.getAttribute('data-price'));
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
    const area = parseInt(elements.areaSize.value) || 10;
    const difficultyLevel = parseInt(elements.difficultySlider.value);
    const difficultyMultiplier = CONFIG.PRICES.difficulty[difficultyLevel];
    
    // –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
    let basePrice = basePricePerM2 * area;
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
    let extraPrice = 0;
    extraPrice += (parseInt(elements.windowsCount.value) || 0) * CONFIG.PRICES.extras.windows;
    extraPrice += (parseInt(elements.cabinetsCount.value) || 0) * CONFIG.PRICES.extras.cabinets;
    extraPrice += (parseInt(elements.fridgeCount.value) || 0) * CONFIG.PRICES.extras.fridge;
    extraPrice += (parseInt(elements.ovenCount.value) || 0) * CONFIG.PRICES.extras.oven;
    extraPrice += (parseInt(elements.hoodCount.value) || 0) * CONFIG.PRICES.extras.hood;
    extraPrice += (parseInt(elements.appliancesCount.value) || 0) * CONFIG.PRICES.extras.appliances;
    
    if (elements.farTrip.checked) {
        extraPrice += CONFIG.PRICES.extras.farTrip;
    }
    
    // –ò—Ç–æ–≥ –¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    let subtotal = basePrice + extraPrice;
    
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞
    if (subtotal < CONFIG.PRICES.minOrder) {
        subtotal = CONFIG.PRICES.minOrder;
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    let finalPrice = subtotal * difficultyMultiplier;
    
    // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ü–µ–ª—ã—Ö
    calculatedPrice = Math.round(finalPrice);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ —Å—É–º–º—ã
    elements.orderTotal.value = calculatedPrice.toLocaleString('ru-RU') + ' ‚ÇΩ';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—Ä–ø–ª–∞—Ç—É –º–∞—Å—Ç–µ—Ä–∞ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø—Ä–æ—Ü–µ–Ω—Ç)
    const activePayment = document.querySelector('.btn-payment-option.active');
    if (activePayment && activePayment.getAttribute('data-percent') !== 'fixed') {
        const percent = parseInt(activePayment.getAttribute('data-percent'));
        const masterPay = Math.round(calculatedPrice * (percent / 100));
        elements.masterPay.value = masterPay;
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–∞–∑–±–∏–≤–∫—É
    displayPriceBreakdown(basePrice, extraPrice, difficultyMultiplier, finalPrice);
}

// –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –†–ê–ó–ë–ò–í–ö–ò –°–¢–û–ò–ú–û–°–¢–ò
function displayPriceBreakdown(basePrice, extraPrice, difficultyMultiplier, finalPrice) {
    const difficultyPercent = Math.round((difficultyMultiplier - 1) * 100);
    const difficultyAdd = Math.round(finalPrice - (basePrice + extraPrice));
    
    elements.basePrice.textContent = formatPrice(basePrice);
    elements.extraPrice.textContent = formatPrice(extraPrice);
    elements.difficultyAdd.textContent = `+${difficultyPercent}% (${formatPrice(difficultyAdd)})`;
    elements.totalPrice.textContent = formatPrice(finalPrice);
}

// –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –¶–ï–ù–´
function formatPrice(price) {
    return Math.round(price).toLocaleString('ru-RU') + ' ‚ÇΩ';
}

// –£–°–¢–ê–ù–û–í–ö–ê –î–ê–¢–´ –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
function setDefaultDateTime() {
    const now = new Date();
    
    // –ó–∞–≤—Ç—Ä–∞—à–Ω—è—è –¥–∞—Ç–∞
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ YYYY-MM-DD
    const year = tomorrow.getFullYear();
    const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
    const day = String(tomorrow.getDate()).padStart(2, '0');
    
    elements.orderDate.value = `${year}-${month}-${day}`;
    
    // –í—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10:00
    elements.orderTime.value = '10:00';
}

// –£–°–¢–ê–ù–û–í–ö–ê –ë–£–î–£–©–ï–ô –î–ê–¢–´
function setFutureDate(days) {
    const now = new Date();
    const futureDate = new Date(now);
    futureDate.setDate(futureDate.getDate() + days);
    
    const year = futureDate.getFullYear();
    const month = String(futureDate.getMonth() + 1).padStart(2, '0');
    const day = String(futureDate.getDate()).padStart(2, '0');
    
    elements.orderDate.value = `${year}-${month}-${day}`;
    updatePreview();
}

// –û–ë–ù–û–í–õ–ï–ù–ò–ï –í–†–ï–ú–ï–ù–ò –ò –î–ê–¢–´ –í –®–ê–ü–ö–ï
function updateDateTime() {
    const now = new Date();
    
    // –í—Ä–µ–º—è
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    elements.currentTime.textContent = `${hours}:${minutes}`;
    
    // –î–∞—Ç–∞
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    elements.currentDate.textContent = `${day}.${month}.${year}`;
}

// –ù–ê–°–¢–†–û–ô–ö–ê –ú–ê–°–ö–ò –¢–ï–õ–ï–§–û–ù–ê
function setupPhoneMask() {
    elements.customerPhone.addEventListener('input', function(e) {
        let value = this.value.replace(/\D/g, '');
        
        if (value.length > 0) {
            if (value[0] === '7' || value[0] === '8') {
                value = value.substring(1);
            }
            
            let formatted = '+7 (';
            
            if (value.length > 0) {
                formatted += value.substring(0, 3);
            }
            if (value.length > 3) {
                formatted += ') ' + value.substring(3, 6);
            }
            if (value.length > 6) {
                formatted += '-' + value.substring(6, 8);
            }
            if (value.length > 8) {
                formatted += '-' + value.substring(8, 10);
            }
            
            this.value = formatted;
        }
    });
}

// –ü–ï–†–ï–•–û–î –ú–ï–ñ–î–£ –®–ê–ì–ê–ú–ò
function goToStep(step) {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
    if (step === 2 && !validateCalculatorStep()) {
        return;
    }
    
    if (step === 3 && !validateDataStep()) {
        return;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥–∏
    elements.steps.forEach(s => {
        s.classList.toggle('active', parseInt(s.getAttribute('data-step')) === step);
        s.classList.toggle('completed', parseInt(s.getAttribute('data-step')) < step);
    });
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –ø–∞–Ω–µ–ª–∏
    Object.keys(elements.panels).forEach((key, index) => {
        elements.panels[key].classList.toggle('active', (index + 1) === step);
    });
    
    currentStep = step;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞ —à–∞–≥–µ 3
    if (step === 3) {
        updatePreview();
    }
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –≤–µ—Ä—Ö—É
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// –í–ê–õ–ò–î–ê–¶–ò–Ø –®–ê–ì–ê 1 (–ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†)
function validateCalculatorStep() {
    if (!selectedCity) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥', 'error');
        return false;
    }
    
    if (!document.querySelector('.service-card.selected')) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É–±–æ—Ä–∫–∏', 'error');
        return false;
    }
    
    const area = parseInt(elements.areaSize.value);
    if (!area || area < 10 || area > 1000) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –ø–ª–æ—â–∞–¥—å (10-1000 –º¬≤)', 'error');
        elements.areaSize.focus();
        return false;
    }
    
    return true;
}

// –í–ê–õ–ò–î–ê–¶–ò–Ø –®–ê–ì–ê 2 (–î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê)
function validateDataStep() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    const manager = elements.managerName.value.trim();
    if (!manager || manager.length < 2) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞', 'error');
        elements.managerName.focus();
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞
    if (!elements.customerName.value.trim()) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –§–ò–û –∫–ª–∏–µ–Ω—Ç–∞', 'error');
        elements.customerName.focus();
        return false;
    }
    
    const phone = elements.customerPhone.value.replace(/\D/g, '');
    if (phone.length < 10) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
        elements.customerPhone.focus();
        return false;
    }
    
    if (!elements.customerStreet.value.trim()) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å —É–±–æ—Ä–∫–∏', 'error');
        elements.customerStreet.focus();
        return false;
    }
    
    return true;
}

// –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–ê
function updatePreview() {
    if (currentStep < 3) return;
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∑–∞—è–≤–∫–∏
    if (!orderId) {
        orderId = 'CLN-' + Date.now().toString().slice(-8) + '-' + 
                 Math.random().toString(36).substr(2, 4).toUpperCase();
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
    elements.previewOrderId.textContent = orderId;
    elements.previewCity.textContent = selectedCity ? selectedCity.name : '–ù–µ –≤—ã–±—Ä–∞–Ω';
    elements.previewChannel.textContent = selectedCity ? selectedCity.channel : '‚Äî';
    
    // –¢–∏–ø —É–±–æ—Ä–∫–∏
    const selectedCard = document.querySelector('.service-card.selected');
    elements.previewType.textContent = selectedCard ? 
        selectedCard.getAttribute('data-type') : '–ù–µ –≤—ã–±—Ä–∞–Ω';
    
    // –ü–ª–æ—â–∞–¥—å
    elements.previewArea.textContent = `${elements.areaSize.value} –º¬≤`;
    
    // –°—Ç–æ–∏–º–æ—Å—Ç—å
    elements.previewPrice.textContent = formatPrice(calculatedPrice);
    
    // –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
    const date = elements.orderDate.value;
    const time = elements.orderTime.value;
    
    if (date) {
        const [year, month, day] = date.split('-');
        elements.previewDate.textContent = `${day}.${month}.${year} ${time || ''}`;
    } else {
        elements.previewDate.textContent = '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
    }
}

// –°–û–ó–î–ê–ù–ò–ï –ó–ê–Ø–í–ö–ò
async function createOrder() {
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    elements.actionButtons.classList.add('hidden');
    elements.statusMessage.classList.remove('hidden');
    elements.resultCard.classList.add('hidden');
    elements.errorCard.classList.add('hidden');
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const orderData = collectOrderData();
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Google Apps Script
        const result = await sendOrderToServer(orderData);
        
        if (result.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
            showSuccessResult(result);
            
            // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±—É—Ñ–µ—Ä
            setTimeout(copyOrderData, 1000);
            
        } else {
            throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
        
    } catch (error) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        showError(error.message);
    }
}

// –°–û–ë–ò–†–ê–ï–ú –î–ê–ù–ù–´–ï –ó–ê–Ø–í–ö–ò
function collectOrderData() {
    // –í—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
    const selectedEquipment = Array.from(
        document.querySelectorAll('#equipmentTags .equipment-tag.selected')
    ).map(tag => tag.querySelector('span').textContent);
    
    // –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ö–∏–º–∏—è
    const selectedChemistry = Array.from(
        document.querySelectorAll('#chemistryTags .equipment-tag.selected')
    ).map(tag => tag.querySelector('span').textContent);
    
    // –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì
    const date = elements.orderDate.value;
    let formattedDate = '';
    if (date) {
        const [year, month, day] = date.split('-');
        formattedDate = `${day}.${month}.${year}`;
    }
    
    return {
        // –°–∏—Å—Ç–µ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        action: 'create_order',
        order_id: orderId,
        timestamp: new Date().toISOString(),
        secret_key: CONFIG.SECRET_KEY,
        
        // –î–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        manager: elements.managerName.value.trim(),
        
        // –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
        customer_name: elements.customerName.value.trim(),
        customer_phone: elements.customerPhone.value.trim(),
        customer_address: `${elements.customerStreet.value.trim()}${elements.customerFlat.value ? ', ' + elements.customerFlat.value.trim() : ''}`,
        customer_flat: elements.customerFlat.value.trim(),
        
        // –ì–æ—Ä–æ–¥
        city: selectedCity.name,
        city_id: selectedCity.id,
        telegram_channel: selectedCity.channel,
        
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —É–±–æ—Ä–∫–∏
        cleaning_type: document.querySelector('.service-card.selected').getAttribute('data-type'),
        area: parseInt(elements.areaSize.value),
        room_type: elements.roomType.value,
        difficulty: parseInt(elements.difficultySlider.value),
        has_pets: elements.hasPets.checked,
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
        windows_count: parseInt(elements.windowsCount.value) || 0,
        cabinets_count: parseInt(elements.cabinetsCount.value) || 0,
        fridge_count: parseInt(elements.fridgeCount.value) || 0,
        oven_count: parseInt(elements.ovenCount.value) || 0,
        hood_count: parseInt(elements.hoodCount.value) || 0,
        appliances_count: parseInt(elements.appliancesCount.value) || 0,
        far_trip: elements.farTrip.checked,
        
        // –§–∏–Ω–∞–Ω—Å—ã
        total_price: calculatedPrice,
        master_pay: elements.masterPay.value || '0',
        master_pay_type: document.querySelector('.btn-payment-option.active').getAttribute('data-percent'),
        
        // –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ —Ö–∏–º–∏—è
        equipment: selectedEquipment.join(', ') || '‚Äî',
        chemistry: selectedChemistry.join(', ') || '‚Äî',
        
        // –í—Ä–µ–º—è –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
        order_date: formattedDate,
        order_time: elements.orderTime.value,
        works_description: elements.worksDescription.value.trim(),
        
        // –°—Ç–∞—Ç—É—Å
        status: '–ù–æ–≤–∞—è'
    };
}

// –û–¢–ü–†–ê–í–ö–ê –ù–ê –°–ï–†–í–ï–†
async function sendOrderToServer(orderData) {
    try {
        const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        return result;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        
        // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ GET
        return await sendOrderToServerAlternative(orderData);
    }
}

// –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –ú–ï–¢–û–î –û–¢–ü–†–ê–í–ö–ò (GET)
async function sendOrderToServerAlternative(orderData) {
    try {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
        const params = new URLSearchParams();
        for (const key in orderData) {
            params.append(key, orderData[key]);
        }
        
        const url = `${CONFIG.GOOGLE_SCRIPT_URL}?${params.toString()}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        
        // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
        try {
            return JSON.parse(text);
        } catch {
            return { success: true, message: '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' };
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞:', error);
        throw error;
    }
}

// –ü–û–ö–ê–ó–ê–¢–¨ –£–°–ü–ï–®–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢
function showSuccessResult(result) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    elements.resultOrderId.textContent = orderId;
    elements.resultCity.textContent = selectedCity.name;
    
    if (result.telegram_link) {
        elements.resultChannelLink.href = result.telegram_link;
        elements.btnTelegram.href = result.telegram_link;
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    elements.statusMessage.classList.add('hidden');
    elements.resultCard.classList.remove('hidden');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showNotification(`–ó–∞—è–≤–∫–∞ ${orderId} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!`, 'success');
}

// –ü–û–ö–ê–ó–ê–¢–¨ –û–®–ò–ë–ö–£
function showError(message) {
    elements.errorMessage.textContent = message;
    
    elements.statusMessage.classList.add('hidden');
    elements.errorCard.classList.remove('hidden');
    
    showNotification(`–û—à–∏–±–∫–∞: ${message}`, 'error');
}

// –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –î–ê–ù–ù–´–• –ó–ê–Ø–í–ö–ò
function copyOrderData() {
    const orderData = collectOrderData();
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    let text = `üßπ –ó–ê–Ø–í–ö–ê –ù–ê –£–ë–û–†–ö–£ ‚Ññ${orderData.order_id}\n`;
    text += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    text += `üìã –û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:\n`;
    text += `–ú–µ–Ω–µ–¥–∂–µ—Ä: ${orderData.manager}\n`;
    text += `–ì–æ—Ä–æ–¥: ${orderData.city}\n`;
    text += `–¢–∏–ø —É–±–æ—Ä–∫–∏: ${orderData.cleaning_type}\n`;
    text += `–ü–ª–æ—â–∞–¥—å: ${orderData.area} –º¬≤\n`;
    text += `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${orderData.total_price.toLocaleString('ru-RU')} ‚ÇΩ\n`;
    text += `–î–∞—Ç–∞: ${orderData.order_date} ${orderData.order_time}\n\n`;
    
    text += `üë§ –î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê:\n`;
    text += `–ò–º—è: ${orderData.customer_name}\n`;
    text += `–¢–µ–ª–µ—Ñ–æ–Ω: ${orderData.customer_phone}\n`;
    text += `–ê–¥—Ä–µ—Å: ${orderData.customer_address}\n\n`;
    
    text += `üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞—è–≤–∫—É –≤ Telegram: ${elements.resultChannelLink.href || '‚Äî'}\n`;
    text += `‚è∞ –°–æ–∑–¥–∞–Ω–∞: ${new Date().toLocaleString('ru-RU')}`;
    
    // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    navigator.clipboard.writeText(text)
        .then(() => {
            showNotification('–î–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ', 'error');
        });
}

// –ü–û–ö–ê–ó–ê–¢–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–ï
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${getNotificationIcon(type)}"></i>
        <span>${message}</span>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${getNotificationColor(type)};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;
    
    // –ê–Ω–∏–º–∞—Ü–∏—è
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.body.appendChild(notification);
    
    // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            notification.remove();
            style.remove();
        }, 300);
    }, 5000);
}

// –ü–û–õ–£–ß–ò–¢–¨ –ò–ö–û–ù–ö–£ –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
function getNotificationIcon(type) {
    switch(type) {
        case 'success': return 'check-circle';
        case 'error': return 'times-circle';
        case 'warning': return 'exclamation-triangle';
        default: return 'info-circle';
    }
}

// –ü–û–õ–£–ß–ò–¢–¨ –¶–í–ï–¢ –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
function getNotificationColor(type) {
    switch(type) {
        case 'success': return 'linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%)';
        case 'error': return 'linear-gradient(135deg, #f72585 0%, #b5179e 100%)';
        case 'warning': return 'linear-gradient(135deg, #f8961e 0%, #e76f51 100%)';
        default: return 'linear-gradient(135deg, #6c757d 0%, #495057 100%)';
    }
}